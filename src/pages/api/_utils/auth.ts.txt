// pages/api/_utils/auth.ts
import type { NextApiRequest } from "next";
import redis from "../../../lib/redis";

export async function getUserIdFromReq(req: NextApiRequest): Promise<number> {
  const header = req.headers.authorization || "";
  const sessionId = header.startsWith("Bearer ") ? header.slice(7) : null;

  if (!sessionId) throw new Error("Unauthorized");

  const session = await redis.get(`session:${sessionId}`);
  if (!session) throw new Error("Unauthorized");

  const data = JSON.parse(session);
  const uid = Number(data.id);

  if (!Number.isInteger(uid) || uid <= 0) throw new Error("Unauthorized");
  return uid;
}